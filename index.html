<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="A 3D browser-based first-person shooter game built with Three.js">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Last Soldier">
    
    <title>Ng∆∞·ªùi L√≠nh Cu·ªëi</title>
    
    <!-- Critical Loading Screen CSS - Inline for immediate display -->
    <style>
        /* Critical loading screen styles - must load first */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        #loading-screen.hidden {
            display: none;
        }
        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 20px;
        }
        .loading-content h1 {
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);
            color: #fff;
        }
        .loading-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6666);
            width: 0%;
            transition: width 0.3s;
            border-radius: 15px;
        }
        #loading-text {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
        }
        /* Hide body content until loaded */
        body:not(.loaded) > *:not(#loading-screen) {
            display: none !important;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }
    </style>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    
    <!-- Load CSS asynchronously - won't block loading screen -->
    <link rel="preload" href="css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/style.css"></noscript>
    
    <link rel="manifest" href="manifest.json">
    
    <!-- Inline Loading Screen Script - Runs immediately, no dependencies -->
    <script>
        (function() {
            // Simple loading progress manager - inline, no dependencies
            var progress = 0;
            var progressBar = document.getElementById('loading-progress');
            var loadingText = document.getElementById('loading-text');
            
            // Update progress function
            function updateProgress(percent, text) {
                progress = Math.min(100, Math.max(0, percent));
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                if (loadingText && text) {
                    loadingText.textContent = text;
                }
            }
            
            // Start loading all resources
            function loadAllResources() {
                updateProgress(10, 'Initializing...');
                
                // Step 1: Load MP3 files
                updateProgress(20, 'Loading audio files...');
                var audioFiles = [
                    'sounds/battlefield-music.mp3',
                    'sounds/rifle-shoot.mp3',
                    'sounds/pistol-shoot.mp3',
                    'sounds/bullet-shoot.mp3'
                ];
                
                var audioPromises = [];
                if (!window._preloadedAudio) {
                    window._preloadedAudio = {};
                }
                
                audioFiles.forEach(function(url) {
                    var audio = new Audio();
                    audio.src = url;
                    audio.preload = 'auto';
                    var promise = new Promise(function(resolve) {
                        audio.addEventListener('canplaythrough', function() {
                            resolve();
                        }, { once: true });
                        audio.addEventListener('error', function() {
                            resolve(); // Continue even if file doesn't exist
                        }, { once: true });
                    });
                    audio.load();
                    window._preloadedAudio[url] = audio;
                    audioPromises.push(promise);
                });
                
                // Step 2: Load CSS and DOM
                updateProgress(40, 'Loading styles...');
                var cssReady = false;
                function checkCSS() {
                    try {
                        cssReady = document.styleSheets.length > 0 || document.readyState === 'complete';
                    } catch(e) {
                        cssReady = document.readyState === 'complete';
                    }
                    if (!cssReady && document.readyState !== 'complete') {
                        setTimeout(checkCSS, 50);
                    } else {
                        loadJSModules();
                    }
                }
                
                // Step 3: Load JS modules
                function loadJSModules() {
                    updateProgress(60, 'Loading JavaScript modules...');
                    
                    // Load main.js first
                    var mainScript = document.createElement('script');
                    mainScript.type = 'module';
                    mainScript.src = 'src/main.js';
                    mainScript.onload = function() {
                        updateProgress(80, 'Preparing game modules...');
                        
                        // Preload game.js and all dependencies
                        var gameScript = document.createElement('script');
                        gameScript.type = 'module';
                        gameScript.textContent = 
                            'import("./src/core/game.js").then(function(m) { window._preloadedGameModule = m; }).catch(function(e) { console.warn("Preload error:", e); });';
                        document.head.appendChild(gameScript);
                        
                        // Wait for audio and then finish
                        Promise.all(audioPromises).then(function() {
                            updateProgress(100, 'Ready!');
                            setTimeout(function() {
                                var loadingScreen = document.getElementById('loading-screen');
                                if (loadingScreen) {
                                    loadingScreen.classList.add('hidden');
                                    document.body.classList.add('loaded');
                                }
                            }, 300);
                        });
                    };
                    mainScript.onerror = function() {
                        updateProgress(100, 'Ready!');
                        setTimeout(function() {
                            var loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen) {
                                loadingScreen.classList.add('hidden');
                                document.body.classList.add('loaded');
                            }
                        }, 300);
                    };
                    document.head.appendChild(mainScript);
                }
                
                // Start checking CSS
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', checkCSS);
                } else {
                    checkCSS();
                }
            }
            
            // Start loading immediately
            loadAllResources();
        })();
    </script>
</head>
<body>
    <div id="game-container"></div>
    
    <!-- UI Elements -->
    <div id="hud">
        <!-- Top Left -->
        <div class="hud-top-left">
            <button class="btn-exit" id="btn-exit">‚úï</button>
            <div class="minimap" id="minimap">
                <canvas id="minimap-canvas"></canvas>
                <div class="minimap-player" id="minimap-player"></div>
            </div>
            <button class="btn-chat" id="btn-chat">üí¨</button>
        </div>
        
        <!-- Info Panel -->
        <div class="info-panel" id="info-panel">
            <div class="info-panel-content">
                <h3 class="info-title">BATTLE STATS</h3>
                <div class="info-stats">
                    <div class="info-stat-row">
                        <span class="info-label">Red Team Killed:</span>
                        <span class="info-value" id="info-red-killed">0</span>
                        <span class="info-threshold">/ 100</span>
                    </div>
                    <div class="info-stat-row">
                        <span class="info-label">Blue Team Killed:</span>
                        <span class="info-value" id="info-blue-killed">0</span>
                        <span class="info-threshold">/ 100</span>
                    </div>
                    <div class="info-threshold-row">
                        <span class="info-label">Winning Threshold:</span>
                        <span class="info-value info-threshold-value">100</span>
                    </div>
                    <div class="info-stat-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="info-status">In Progress</span>
                    </div>
                    <div class="info-stat-row">
                        <span class="info-label">Your Deaths:</span>
                        <span class="info-value" id="info-player-deaths">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Center -->
        <div class="hud-top-center">
            <div class="health-bar red-bar" id="team-red-bar">
                <span class="score-value" id="team-red-score">100</span>
            </div>
            <div class="timer" id="timer">49:37</div>
            <div class="health-bar blue-bar" id="team-blue-bar">
                <span class="score-value" id="team-blue-score">100</span>
            </div>
        </div>

        <!-- Top Right -->
        <div class="hud-top-right">
            <button class="btn-info" id="btn-info">‚ÑπÔ∏è</button>
            <div class="weapon-icon" id="weapon-icon"></div>
            <div class="ammo-count" id="ammo-count">
                <span id="ammo-current">4</span>
                <span id="ammo-separator">/</span>
                <span id="ammo-reserve">54</span>
            </div>
            <div class="health-bar red-bar" id="player-health-bar">
                <span class="health-value" id="player-health">100 +</span>
            </div>
        </div>

        <!-- Bottom Left - Movement Controls -->
        <div class="hud-bottom-left">
            <div class="joystick-container" id="joystick-container">
                <div class="joystick" id="joystick"></div>
            </div>
        </div>

        <!-- Bottom Right - Action Controls -->
        <div class="hud-bottom-right">
            <button class="btn-action" id="btn-fire" title="Left Click">
                <span class="btn-icon">üéØ</span>
                <span class="btn-key">LMB</span>
            </button>
            <button class="btn-action" id="btn-aim" title="Right Click">
                <span class="btn-icon">üîç</span>
                <span class="btn-key">RMB</span>
            </button>
            <button class="btn-action" id="btn-reload" title="R Key">
                <span class="btn-icon">üîÑ</span>
                <span class="btn-key">R</span>
            </button>
            <button class="btn-action" id="btn-weapon-switch" title="Switch Weapon">
                <span class="btn-icon">üî´</span>
                <span class="btn-key">SW</span>
            </button>
            <button class="btn-action" id="btn-grenade" title="G Key">
                <span class="btn-icon">üí£</span>
                <span class="btn-key">G</span>
            </button>
            <button class="btn-action" id="btn-sprint" title="Shift Key">
                <span class="btn-icon">üèÉ</span>
                <span class="btn-key">SHIFT</span>
            </button>
            <button class="btn-action" id="btn-crouch" title="Ctrl Key">
                <span class="btn-icon">‚¨áÔ∏è</span>
                <span class="btn-key">CTRL</span>
            </button>
            <button class="btn-action" id="btn-jump" title="Space Key">
                <span class="btn-icon">‚¨ÜÔ∏è</span>
                <span class="btn-key">SPACE</span>
            </button>
        </div>

        <!-- Center Crosshair -->
        <div class="crosshair" id="crosshair"></div>
        
        <!-- Grenade Power Bar -->
        <div class="grenade-power-bar-container" id="grenade-power-bar-container">
            <div class="grenade-power-bar-label">Power</div>
            <div class="grenade-power-bar">
                <div class="grenade-power-bar-fill" id="grenade-power-bar-fill"></div>
            </div>
        </div>
        
        <!-- Deployment Notification -->
        <div class="deployment-notification" id="deployment-notification"></div>
        
        <!-- Respawn Progress Bar -->
        <div class="respawn-progress-container" id="respawn-progress-container">
            <div class="respawn-progress-label">RESPAWNING...</div>
            <div class="respawn-progress-bar">
                <div class="respawn-progress-fill" id="respawn-progress-fill"></div>
            </div>
            <div class="respawn-progress-time" id="respawn-progress-time">3</div>
        </div>
    </div>

    <!-- Weapon Display -->
    <div class="weapon-display" id="weapon-display"></div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <h1>Ng∆∞·ªùi L√≠nh Cu·ªëi</h1>
            <div class="loading-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
            <p id="loading-text">ƒêang t·∫£i...</p>
        </div>
    </div>

    <!-- Menu Screens -->
    <!-- Main Menu -->
    <div id="screen-main-menu" class="menu-screen active">
        <div class="menu-background-3d" id="main-menu-background"></div>
        <div class="menu-background"></div>
        <div class="menu-content">
            <div class="menu-top-right">
                <div class="community-maps-thumbnail">
                    <div class="community-maps-image"></div>
                    <div class="community-maps-label">COMMUNITY MAPS</div>
                </div>
            </div>
            <div class="main-menu-options">
                <button id="menu-play" class="menu-option active">PLAY</button>
                <button id="menu-customize" class="menu-option">CUSTOMIZE</button>
                <button id="menu-settings" class="menu-option">SETTINGS</button>
                <button id="menu-about" class="menu-option">ABOUT</button>
            </div>
        </div>
    </div>

    <!-- Play Mode Selection -->
    <div id="screen-play-mode" class="menu-screen">
        <div class="menu-background"></div>
        <div class="menu-content">
            <button class="btn-back">‚Üê</button>
            <div class="play-mode-grid">
                <div class="play-mode-panel" id="play-mode-map-editor">
                    <div class="play-mode-preview" id="preview-map-editor"></div>
                    <h2>MAP EDITOR</h2>
                    <p>Make your own maps!</p>
                </div>
                <div class="play-mode-panel" id="play-mode-join-match">
                    <div class="play-mode-preview" id="preview-join-match"></div>
                    <h2>JOIN MATCH</h2>
                    <p>Join your friends game.</p>
                    <div class="ip-address">192.168.43.1:7777</div>
                </div>
                <div class="play-mode-panel" id="play-mode-online-match">
                    <div class="play-mode-preview" id="preview-online-match"></div>
                    <h2>ONLINE MATCH</h2>
                    <p>Find the game from the server browser.</p>
                </div>
                <div class="play-mode-panel active" id="play-mode-create-match">
                    <div class="play-mode-preview" id="preview-create-match"></div>
                    <h2>CREATE MATCH</h2>
                    <p>Make your own custom match to play over local network.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Battlefield Deploy -->
    <div id="screen-battlefield-deploy" class="menu-screen">
        <div class="menu-background"></div>
        <div class="menu-content">
            <div class="battlefield-top">
                <button class="btn-back">‚Üê</button>
                <button class="btn-chat-menu">üí¨</button>
                <div class="battlefield-scores">
                    <div class="team-score-battlefield">
                        <span class="score-value">100</span>
                        <span class="flag-icon">üá¨üáß</span>
                        <div class="score-bar red-bar"></div>
                    </div>
                    <div class="timer-battlefield">49:59</div>
                    <div class="team-score-battlefield">
                        <span class="flag-icon">üá©üá™</span>
                        <span class="score-value">100</span>
                        <div class="score-bar blue-bar"></div>
                    </div>
                </div>
                <div class="strategic-points">
                    <span class="point">A</span>
                    <span class="point">B</span>
                    <span class="point">C</span>
                    <span class="point">D</span>
                    <span class="point">E</span>
                </div>
            </div>
            <div class="battlefield-map">
                <canvas id="battlefield-canvas"></canvas>
            </div>
            <div class="battlefield-bottom">
                <div class="deploy-controls">
                    <div class="deploy-icons">
                        <div class="deploy-icon">‚≠ê</div>
                        <div class="deploy-icon">+</div>
                        <div class="deploy-icon">üá¨üáß</div>
                        <div class="deploy-icon">üö´</div>
                        <div class="deploy-icon">üöó</div>
                    </div>
                    <button id="btn-deploy" class="btn-deploy">DEPLOY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customize Screen -->
    <div id="screen-customize" class="menu-screen">
        <div class="menu-background"></div>
        <div class="menu-content">
            <button class="btn-back">‚Üê</button>
            <h1 class="screen-title">CUSTOMIZE</h1>
            <div class="customize-content">
                <div class="customize-left">
                    <div class="weapon-section active" data-section="primary">
                        <h3 class="weapon-section-header">PRIMARY</h3>
                        <div class="weapon-display-large">
                            <div class="weapon-silhouette" id="primary-display">·°ï·†µ„Éá·°Å·†ä‚ïæ‚îÅ</div>
                        </div>
                    </div>
                    <div class="weapon-section" data-section="secondary">
                        <h3 class="weapon-section-header">SECONDARY</h3>
                        <div class="weapon-display-large">
                            <div class="weapon-silhouette" id="secondary-display"> Ã∏Ã≥ÃîÃé‚ÄãÃéÃé ÃøÃøÃÖÃÖ/ ÃîÃÖÃÖ ÃøÃø ÃøÃø Ãø ÃøÃø ÃøÃøÃÖÃÖ ÃøÃø</div>
                        </div>
                    </div>
                    <div class="weapon-section" data-section="gadget">
                        <h3 class="weapon-section-header">GADGET</h3>
                        <div class="weapon-display-large">
                            <div class="weapon-silhouette" id="gadget-display">‚ñ¨ŒπìÜÉ</div>
                        </div>
                    </div>
                </div>
                <div class="customize-right">
                    <div class="item-detail-view" id="item-detail-view">
                        <div class="detail-placeholder">Select a category to view options</div>
                    </div>
                </div>
            </div>
            <div class="customize-bottom">
                <input type="text" id="player-name-input" class="player-name-input" placeholder="player name..." value="player name...">
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="screen-settings" class="menu-screen">
        <div class="menu-background"></div>
        <div class="menu-content settings-content">
            <button class="btn-back">‚Üê</button>
            <h1 class="screen-title">SETTINGS</h1>
            <div class="settings-grid">
                <div class="settings-row">
                    <div class="settings-item">
                        <label>MUSIC</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="music" min="0" max="100" value="100">
                            <span class="settings-value" data-display="music">100%</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>GAME</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="game" min="0" max="100" value="100">
                            <span class="settings-value" data-display="game">100%</span>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-item">
                        <label>GRAPHICS</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="graphics" min="0" max="100" value="50">
                            <span class="settings-value" data-display="graphics">MED</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>RESOLUTION</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="resolution" min="0" max="100" value="80">
                            <span class="settings-value" data-display="resolution">80%</span>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-item">
                        <label>REAL-TIME SHADOWS</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="realTimeShadows">
                    </div>
                    <div class="settings-item">
                        <label>BAKE SHADOWS</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="bakeShadows">
                    </div>
                    <div class="settings-item">
                        <label>FRAME RATE</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="frameRate" min="30" max="120" value="60" step="30">
                            <span class="settings-value" data-display="frameRate">60 FPS</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>SHOW FPS</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="showFPS">
                    </div>
                    <div class="settings-item">
                        <label>SHOW CHAT</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="showChat">
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-item">
                        <label>BLOOM</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="bloom">
                    </div>
                    <div class="settings-item">
                        <label>MOTION BLUR</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="motionBlur">
                    </div>
                    <div class="settings-item">
                        <label>FISHEYE LENS</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="fisheyeLens">
                    </div>
                    <div class="settings-item">
                        <label>FILM GRAIN</label>
                        <input type="checkbox" class="settings-checkbox" data-setting="filmGrain" checked>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-item">
                        <label>GYRO LOOK</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="gyroLook" min="0" max="100" value="0">
                            <span class="settings-value" data-display="gyroLook">0%</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>GYRO ADS</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="gyroADS" min="0" max="100" value="0">
                            <span class="settings-value" data-display="gyroADS">0%</span>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-item">
                        <label>LOOK SENSITIVITY</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="lookSensitivity" min="0" max="100" value="50">
                            <span class="settings-value" data-display="lookSensitivity">50%</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>ADS SENS</label>
                        <div class="settings-control">
                            <input type="range" class="settings-slider" data-setting="adsSens" min="0" max="100" value="25">
                            <span class="settings-value" data-display="adsSens">25%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Screen -->
    <div id="screen-about" class="menu-screen">
        <div class="menu-background"></div>
        <div class="menu-content about-content">
            <button class="btn-back">‚Üê</button>
            <div class="about-text">
                <div class="about-version">1.2</div>
                <div class="about-engine">Three.js</div>
                <div class="about-section">
                    <h2>Game:</h2>
                    <p><strong>The Last Soldier</strong></p>
                    <p>Ng∆∞·ªùi L√≠nh Cu·ªëi</p>
                </div>
                <div class="about-section">
                    <h2>Developed By:</h2>
                    <p>Monk Journey Team</p>
                </div>
                <div class="about-section">
                    <h2>Technologies:</h2>
                    <p>Three.js - 3D Graphics Rendering</p>
                    <p>Vanilla JavaScript (ES6 Modules)</p>
                    <p>HTML5 / CSS3</p>
                    <p>Web Audio API</p>
                </div>
                <div class="about-section">
                    <h2>Copyright:</h2>
                    <p>¬© 2025 Monk Journey Team</p>
                    <p>All Rights Reserved</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="importmap">
    {
        "imports": {
            "three": "./lib/three/build/three.module.js",
            "three/addons/": "./lib/three/examples/jsm/",
            "three/addons/libs/stats.module.js": "./lib/three/examples/jsm/libs/stats.module.js"
        }
    }
    </script>
    
    <script type="module" src="src/main.js"></script>
    
    <!-- Version Info -->
    <div style="position: fixed; bottom: 10px; right: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.6); font-family: Arial, sans-serif; z-index: 10000;">
        version: 1.2
    </div>
</body>
</html>

